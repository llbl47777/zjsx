<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Scheduler Pro - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-healthy { color: #10b981; }
        .status-unhealthy { color: #ef4444; }
        .status-recovering { color: #f59e0b; }
        .status-draining { color: #6b7280; }
        .status-warming_up { color: #3b82f6; }
        
        /* ç†”æ–­å™¨çŠ¶æ€ */
        .circuit-closed { background: #10b981; }
        .circuit-open { background: #ef4444; }
        .circuit-half_open { background: #f59e0b; }
        
        /* åŠ¨ç”» */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slide-in 0.3s ease-out; }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 0.5s ease-out;
        }
        
        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .stat-card {
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        /* è¡¨æ ¼è¡Œæ‚¬åœ */
        .worker-row:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app" class="container mx-auto px-4 py-6 max-w-7xl">
        
        <!-- ==================== å¤´éƒ¨ ==================== -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl">ğŸš€</div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                            LLM Scheduler Pro
                        </h1>
                        <p class="text-gray-400 text-sm mt-1">Enterprise Load Balancer Dashboard v3.0</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 flex-wrap">
                    <div id="ws-status" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm bg-red-500/20 text-red-400 border border-red-500/30">
                        <span class="w-2 h-2 rounded-full bg-red-500 pulse-dot"></span>
                        <span>æ–­å¼€è¿æ¥</span>
                    </div>
                    <div class="text-gray-400 text-sm">
                        <span>è¿è¡Œæ—¶é—´: </span>
                        <span id="uptime" class="font-mono text-white">--:--:--</span>
                    </div>
                    <div class="text-gray-500 text-xs">
                        <span id="current-time"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- ==================== ç»Ÿè®¡å¡ç‰‡ ==================== -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- æ€»è¯·æ±‚æ•° -->
            <div class="stat-card bg-gradient-to-br from-gray-800 to-gray-800/50 rounded-2xl p-5 border border-gray-700/50 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">æ€»è¯·æ±‚æ•°</p>
                        <p id="total-requests" class="text-3xl font-bold text-white">0</p>
                        <p class="text-xs mt-2">
                            <span class="text-green-400">â†‘</span>
                            <span id="qps" class="text-green-400 font-medium">0</span>
                            <span class="text-gray-500"> req/s</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center text-2xl">
                        ğŸ“Š
                    </div>
                </div>
            </div>
            
            <!-- æ´»è·ƒè¯·æ±‚ -->
            <div class="stat-card bg-gradient-to-br from-gray-800 to-gray-800/50 rounded-2xl p-5 border border-gray-700/50 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">æ´»è·ƒè¯·æ±‚</p>
                        <p id="active-requests" class="text-3xl font-bold text-white">0</p>
                        <p class="text-xs text-gray-500 mt-2">æ­£åœ¨å¤„ç†ä¸­</p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center text-2xl">
                        âš¡
                    </div>
                </div>
            </div>
            
            <!-- å¹³å‡å»¶è¿Ÿ -->
            <div class="stat-card bg-gradient-to-br from-gray-800 to-gray-800/50 rounded-2xl p-5 border border-gray-700/50 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">å¹³å‡å»¶è¿Ÿ</p>
                        <p id="avg-latency" class="text-3xl font-bold text-white">0<span class="text-lg text-gray-400">ms</span></p>
                        <p class="text-xs mt-2">
                            <span class="text-gray-500">P95:</span>
                            <span id="p95-latency" class="text-yellow-400 font-medium">0ms</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center text-2xl">
                        â±ï¸
                    </div>
                </div>
            </div>
            
            <!-- å¥åº·Worker -->
            <div class="stat-card bg-gradient-to-br from-gray-800 to-gray-800/50 rounded-2xl p-5 border border-gray-700/50 shadow-xl">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">å¥åº·èŠ‚ç‚¹</p>
                        <p class="text-3xl font-bold">
                            <span id="healthy-count" class="text-green-400">0</span>
                            <span class="text-gray-500 text-xl">/</span>
                            <span id="total-count" class="text-white">0</span>
                        </p>
                        <p class="text-xs mt-2">
                            <span class="text-gray-500">ç­–ç•¥:</span>
                            <span id="routing-strategy" class="text-blue-400 font-medium">--</span>
                        </p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center text-2xl">
                        ğŸ–¥ï¸
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ä¸»è¦å†…å®¹åŒº ==================== -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
            
            <!-- Workers è¡¨æ ¼ (å 2åˆ—) -->
            <div class="xl:col-span-2 bg-gray-800/50 rounded-2xl border border-gray-700/50 shadow-xl overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span>ğŸ–¥ï¸</span>
                        <span>Workers çŠ¶æ€</span>
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="refreshWorkers()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs transition flex items-center gap-1">
                            <span>ğŸ”„</span>
                            <span>åˆ·æ–°</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-900/50 text-xs uppercase text-gray-400">
                            <tr>
                                <th class="px-4 py-3 text-left">Worker</th>
                                <th class="px-4 py-3 text-left">çŠ¶æ€</th>
                                <th class="px-4 py-3 text-center">è¿è¡Œä¸­</th>
                                <th class="px-4 py-3 text-center">ç­‰å¾…ä¸­</th>
                                <th class="px-4 py-3 text-left">KVç¼“å­˜</th>
                                <th class="px-4 py-3 text-center">QPS</th>
                                <th class="px-4 py-3 text-center">å»¶è¿Ÿ</th>
                                <th class="px-4 py-3 text-center">ç†”æ–­å™¨</th>
                                <th class="px-4 py-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="workers-table" class="divide-y divide-gray-700/50">
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center gap-2">
                                        <div class="text-4xl">ğŸ”Œ</div>
                                        <p>ç­‰å¾…è¿æ¥...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å®æ—¶å‘Šè­¦ (å 1åˆ—) -->
            <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 shadow-xl overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span>ğŸ””</span>
                        <span>å®æ—¶å‘Šè­¦</span>
                    </h2>
                    <span id="alert-count" class="px-2 py-0.5 bg-gray-700 rounded-full text-xs">0</span>
                </div>
                <div id="alerts-list" class="p-4 space-y-3 max-h-80 overflow-y-auto">
                    <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">âœ…</div>
                        <p class="text-sm">æš‚æ— å‘Šè­¦</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== å›¾è¡¨åŒºåŸŸ ==================== -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- QPS å›¾è¡¨ -->
            <div class="bg-gray-800/50 rounded-2xl p-6 border border-gray-700/50 shadow-xl">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>ğŸ“ˆ</span>
                    <span>è¯·æ±‚é€Ÿç‡ (QPS)</span>
                </h3>
                <div class="h-48">
                    <canvas id="qps-chart"></canvas>
                </div>
            </div>
            
            <!-- å»¶è¿Ÿå›¾è¡¨ -->
            <div class="bg-gray-800/50 rounded-2xl p-6 border border-gray-700/50 shadow-xl">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>â±ï¸</span>
                    <span>å“åº”å»¶è¿Ÿ (ms)</span>
                </h3>
                <div class="h-48">
                    <canvas id="latency-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- ==================== Worker è´Ÿè½½åˆ†å¸ƒ ==================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- è¯·æ±‚åˆ†å¸ƒé¥¼å›¾ -->
            <div class="bg-gray-800/50 rounded-2xl p-6 border border-gray-700/50 shadow-xl">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>ğŸ¯</span>
                    <span>è¯·æ±‚åˆ†å¸ƒ</span>
                </h3>
                <div class="h-48">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="bg-gray-800/50 rounded-2xl p-6 border border-gray-700/50 shadow-xl">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>â„¹ï¸</span>
                    <span>ç³»ç»Ÿä¿¡æ¯</span>
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">ç‰ˆæœ¬</span>
                        <span class="font-mono">v3.0.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">è·¯ç”±ç­–ç•¥</span>
                        <span id="sys-strategy" class="text-blue-400">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">é™æµçŠ¶æ€</span>
                        <span id="sys-ratelimit" class="text-green-400">å¯ç”¨</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">ç†”æ–­å™¨</span>
                        <span id="sys-circuit" class="text-green-400">å¯ç”¨</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">æ€»ååé‡</span>
                        <span id="sys-throughput" class="font-mono">0 tok/s</span>
                    </div>
                </div>
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            <div class="bg-gray-800/50 rounded-2xl p-6 border border-gray-700/50 shadow-xl">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>âš™ï¸</span>
                    <span>å¿«æ·æ“ä½œ</span>
                </h3>
                <div class="space-y-3">
                    <button onclick="resetAllCircuitBreakers()" class="w-full px-4 py-2.5 bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-400 rounded-xl text-sm transition flex items-center justify-center gap-2 border border-yellow-600/30">
                        <span>ğŸ”„</span>
                        <span>é‡ç½®æ‰€æœ‰ç†”æ–­å™¨</span>
                    </button>
                    <button onclick="refreshConfig()" class="w-full px-4 py-2.5 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 rounded-xl text-sm transition flex items-center justify-center gap-2 border border-blue-600/30">
                        <span>ğŸ“‹</span>
                        <span>åˆ·æ–°é…ç½®</span>
                    </button>
                    <button onclick="exportMetrics()" class="w-full px-4 py-2.5 bg-green-600/20 hover:bg-green-600/30 text-green-400 rounded-xl text-sm transition flex items-center justify-center gap-2 border border-green-600/30">
                        <span>ğŸ“Š</span>
                        <span>å¯¼å‡º Prometheus æŒ‡æ ‡</span>
                    </button>
                    <button onclick="openDocs()" class="w-full px-4 py-2.5 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded-xl text-sm transition flex items-center justify-center gap-2 border border-gray-600/30">
                        <span>ğŸ“–</span>
                        <span>API æ–‡æ¡£</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== é¡µè„š ==================== -->
        <footer class="text-center text-gray-500 text-xs py-4 border-t border-gray-800">
            <p>LLM Scheduler Pro v3.0 | Enterprise Load Balancer</p>
            <p class="mt-1">Made with â¤ï¸ for LLM Infrastructure</p>
        </footer>
    </div>

    <!-- ==================== æ¨¡æ€æ¡† ==================== -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modal-title" class="text-lg font-semibold">æ“ä½œç¡®è®¤</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div id="modal-content" class="text-gray-300 mb-6"></div>
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">å–æ¶ˆ</button>
                <button id="modal-confirm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // å…¨å±€çŠ¶æ€
        // ============================================================
        let ws = null;
        let wsReconnectTimer = null;
        let qpsHistory = [];
        let latencyHistory = [];
        let alerts = [];
        let qpsChart, latencyChart, distributionChart;
        let workerDistribution = {};

        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            connectWebSocket();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }

        // ============================================================
        // WebSocket è¿æ¥
        // ============================================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                
                // è®¢é˜…æ¶ˆæ¯
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    topics: ['metrics', 'worker_status', 'alert', 'config_update']
                }));
                
                // æ¸…é™¤é‡è¿å®šæ—¶å™¨
                if (wsReconnectTimer) {
                    clearTimeout(wsReconnectTimer);
                    wsReconnectTimer = null;
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                
                // 5ç§’åé‡è¿
                wsReconnectTimer = setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('ws-status');
            if (connected) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span><span>å·²è¿æ¥</span>';
                el.className = 'flex items-center gap-2 px-4 py-2 rounded-full text-sm bg-green-500/20 text-green-400 border border-green-500/30';
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 pulse-dot"></span><span>æ–­å¼€è¿æ¥</span>';
                el.className = 'flex items-center gap-2 px-4 py-2 rounded-full text-sm bg-red-500/20 text-red-400 border border-red-500/30';
            }
        }

        // ============================================================
        // æ¶ˆæ¯å¤„ç†
        // ============================================================
        function handleMessage(msg) {
            switch (msg.type) {
                case 'metrics':
                    updateMetrics(msg.data);
                    break;
                case 'worker_status':
                    addAlert({
                        severity: msg.data.new_status === 'healthy' ? 'info' : 'warning',
                        title: 'Worker çŠ¶æ€å˜æ›´',
                        message: `${msg.data.url}: ${msg.data.old_status} â†’ ${msg.data.new_status}`,
                        timestamp: Date.now() / 1000
                    });
                    break;
                case 'alert':
                    addAlert(msg.data);
                    break;
                case 'config_update':
                    addAlert({
                        severity: 'info',
                        title: 'é…ç½®æ›´æ–°',
                        message: `${msg.data.key}: ${msg.data.new_value}`,
                        timestamp: Date.now() / 1000
                    });
                    break;
            }
        }

        // ============================================================
        // æ›´æ–°æŒ‡æ ‡
        // ============================================================
        function updateMetrics(data) {
            const gw = data.gateway;
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('total-requests').textContent = formatNumber(gw.total_requests);
            document.getElementById('active-requests').textContent = gw.active_requests;
            document.getElementById('avg-latency').innerHTML = `${gw.avg_latency_ms.toFixed(0)}<span class="text-lg text-gray-400">ms</span>`;
            document.getElementById('p95-latency').textContent = `${gw.p95_latency_ms.toFixed(0)}ms`;
            document.getElementById('qps').textContent = gw.requests_per_second.toFixed(1);
            document.getElementById('healthy-count').textContent = gw.healthy_workers;
            document.getElementById('total-count').textContent = gw.total_workers;
            document.getElementById('routing-strategy').textContent = formatStrategy(gw.routing_strategy);
            document.getElementById('uptime').textContent = formatDuration(gw.uptime_seconds);
            
            // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
            document.getElementById('sys-strategy').textContent = formatStrategy(gw.routing_strategy);
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            qpsHistory.push(gw.requests_per_second);
            if (qpsHistory.length > 60) qpsHistory.shift();
            
            latencyHistory.push(gw.avg_latency_ms);
            if (latencyHistory.length > 60) latencyHistory.shift();
            
            updateCharts();
            
            // æ›´æ–° Workers è¡¨æ ¼
            if (data.workers) {
                updateWorkersTable(data.workers);
                updateDistributionChart(data.workers);
            }
        }

        function updateWorkersTable(workers) {
            const tbody = document.getElementById('workers-table');
            
            if (Object.keys(workers).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-2">
                                <div class="text-4xl">ğŸ”Œ</div>
                                <p>æ²¡æœ‰é…ç½® Worker</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            Object.entries(workers).forEach(([url, w], index) => {
                const statusClass = `status-${w.status}`;
                const statusText = {
                    'healthy': 'å¥åº·',
                    'unhealthy': 'æ•…éšœ',
                    'recovering': 'æ¢å¤ä¸­',
                    'draining': 'ä¸‹çº¿ä¸­',
                    'warming_up': 'é¢„çƒ­ä¸­'
                }[w.status] || w.status;
                
                const circuitClass = `circuit-${w.circuit_state || 'closed'}`;
                const circuitText = {
                    'closed': 'å…³é—­',
                    'open': 'ç†”æ–­',
                    'half_open': 'åŠå¼€'
                }[w.circuit_state || 'closed'];
                
                const kvPercent = (w.kv_cache_usage * 100).toFixed(1);
                const kvColor = w.kv_cache_usage > 0.8 ? 'bg-red-500' : w.kv_cache_usage > 0.6 ? 'bg-yellow-500' : 'bg-blue-500';
                
                const row = document.createElement('tr');
                row.className = 'worker-row transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-medium text-sm">${w.name || 'Worker ' + index}</div>
                        <div class="text-xs text-gray-500 font-mono truncate max-w-[200px]">${url}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="${statusClass} font-medium text-sm flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-current"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-mono text-lg">${w.running}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-mono text-lg text-yellow-400">${w.waiting}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                            <div class="${kvColor} h-2 rounded-full progress-bar" style="width: ${kvPercent}%"></div>
                        </div>
                        <span class="text-xs text-gray-400">${kvPercent}%</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-mono">${(w.requests_per_second || 0).toFixed(1)}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-mono">${(w.avg_latency_ms || 0).toFixed(0)}ms</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${circuitClass} text-white">${circuitText}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="drainWorker(${index})" class="p-1.5 hover:bg-yellow-600/20 rounded-lg text-yellow-400 text-xs" title="ä¸‹çº¿">
                                â¸ï¸
                            </button>
                            <button onclick="resetCircuitBreaker(${index})" class="p-1.5 hover:bg-blue-600/20 rounded-lg text-blue-400 text-xs" title="é‡ç½®ç†”æ–­">
                                ğŸ”„
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================================
        // å›¾è¡¨
        // ============================================================
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(75, 85, 99, 0.3)' },
                        ticks: { color: '#9ca3af' }
                    },
                    x: {
                        display: false
                    }
                },
                elements: {
                    point: { radius: 0 },
                    line: { tension: 0.4 }
                }
            };

            // QPS å›¾è¡¨
            qpsChart = new Chart(document.getElementById('qps-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });

            // å»¶è¿Ÿå›¾è¡¨
            latencyChart = new Chart(document.getElementById('latency-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });

            // åˆ†å¸ƒé¥¼å›¾
            distributionChart = new Chart(document.getElementById('distribution-chart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9ca3af', boxWidth: 12, padding: 8 }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            qpsChart.data.datasets[0].data = qpsHistory;
            qpsChart.update('none');
            
            latencyChart.data.datasets[0].data = latencyHistory;
            latencyChart.update('none');
        }

        function updateDistributionChart(workers) {
            const labels = [];
            const data = [];
            
            Object.entries(workers).forEach(([url, w], i) => {
                labels.push(w.name || `Worker ${i}`);
                data.push(w.total_requests || 0);
            });
            
            distributionChart.data.labels = labels;
            distributionChart.data.datasets[0].data = data;
            distributionChart.update('none');
        }

        // ============================================================
        // å‘Šè­¦
        // ============================================================
        function addAlert(alert) {
            alerts.unshift(alert);
            if (alerts.length > 20) alerts.pop();
            
            document.getElementById('alert-count').textContent = alerts.length;
            
            const list = document.getElementById('alerts-list');
            const severityConfig = {
                info: { bg: 'bg-blue-500/10', border: 'border-blue-500/30', icon: 'â„¹ï¸' },
                warning: { bg: 'bg-yellow-500/10', border: 'border-yellow-500/30', icon: 'âš ï¸' },
                error: { bg: 'bg-red-500/10', border: 'border-red-500/30', icon: 'âŒ' },
                critical: { bg: 'bg-red-600/20', border: 'border-red-600/50', icon: 'ğŸš¨' }
            };
            
            list.innerHTML = alerts.map(a => {
                const config = severityConfig[a.severity] || severityConfig.info;
                const time = new Date(a.timestamp * 1000).toLocaleTimeString('zh-CN');
                return `
                    <div class="slide-in p-3 rounded-xl ${config.bg} border ${config.border}">
                        <div class="flex items-start gap-2">
                            <span class="text-lg">${config.icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between gap-2">
                                    <span class="font-medium text-sm truncate">${a.title}</span>
                                    <span class="text-xs text-gray-500 flex-shrink-0">${time}</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 truncate">${a.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================
        // æ“ä½œ
        // ============================================================
        async function refreshWorkers() {
            try {
                const resp = await fetch('/api/workers');
                const data = await resp.json();
                console.log('Workers refreshed:', data);
            } catch (e) {
                console.error('Failed to refresh workers:', e);
            }
        }

        async function drainWorker(index) {
            showModal('ç¡®è®¤ä¸‹çº¿', `ç¡®å®šè¦ä¸‹çº¿ Worker ${index} å—ï¼Ÿ`, async () => {
                try {
                    await fetch(`/api/workers/${index}/drain`, { method: 'POST' });
                    addAlert({ severity: 'info', title: 'æ“ä½œæˆåŠŸ', message: `Worker ${index} å·²å¼€å§‹ä¸‹çº¿`, timestamp: Date.now()/1000 });
                } catch (e) {
                    addAlert({ severity: 'error', title: 'æ“ä½œå¤±è´¥', message: e.message, timestamp: Date.now()/1000 });
                }
                closeModal();
            });
        }

        async function resetCircuitBreaker(index) {
            try {
                await fetch(`/api/circuit-breaker/${index}/reset`, { method: 'POST' });
                addAlert({ severity: 'info', title: 'æ“ä½œæˆåŠŸ', message: `Worker ${index} ç†”æ–­å™¨å·²é‡ç½®`, timestamp: Date.now()/1000 });
            } catch (e) {
                addAlert({ severity: 'error', title: 'æ“ä½œå¤±è´¥', message: e.message, timestamp: Date.now()/1000 });
            }
        }

        async function resetAllCircuitBreakers() {
            showModal('ç¡®è®¤é‡ç½®', 'ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç†”æ–­å™¨å—ï¼Ÿ', async () => {
                // è·å–æ‰€æœ‰ worker å¹¶é‡ç½®
                try {
                    const resp = await fetch('/api/workers');
                    const data = await resp.json();
                    for (let i = 0; i < data.workers.length; i++) {
                        await fetch(`/api/circuit-breaker/${i}/reset`, { method: 'POST' });
                    }
                    addAlert({ severity: 'info', title: 'æ“ä½œæˆåŠŸ', message: 'æ‰€æœ‰ç†”æ–­å™¨å·²é‡ç½®', timestamp: Date.now()/1000 });
                } catch (e) {
                    addAlert({ severity: 'error', title: 'æ“ä½œå¤±è´¥', message: e.message, timestamp: Date.now()/1000 });
                }
                closeModal();
            });
        }

        async function refreshConfig() {
            try {
                const resp = await fetch('/api/config');
                const data = await resp.json();
                console.log('Config:', data);
                addAlert({ severity: 'info', title: 'é…ç½®å·²åˆ·æ–°', message: JSON.stringify(data.settings).slice(0, 50) + '...', timestamp: Date.now()/1000 });
            } catch (e) {
                addAlert({ severity: 'error', title: 'è·å–é…ç½®å¤±è´¥', message: e.message, timestamp: Date.now()/1000 });
            }
        }

        function exportMetrics() {
            window.open('/metrics', '_blank');
        }

        function openDocs() {
            window.open('/docs', '_blank');
        }

        // ============================================================
        // æ¨¡æ€æ¡†
        // ============================================================
        function showModal(title, content, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('modal-confirm').onclick = onConfirm;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        // ============================================================
        // å·¥å…·å‡½æ•°
        // ============================================================
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function formatStrategy(strategy) {
            const names = {
                'round_robin': 'è½®è¯¢',
                'weighted_round_robin': 'åŠ æƒè½®è¯¢',
                'least_queue': 'æœ€çŸ­é˜Ÿåˆ—',
                'least_connections': 'æœ€å°‘è¿æ¥',
                'p2c_kv': 'P2C-KV',
                'consistent_hash': 'ä¸€è‡´æ€§å“ˆå¸Œ',
                'adaptive': 'è‡ªé€‚åº”',
                'random': 'éšæœº'
            };
            return names[strategy] || strategy;
        }
    </script>
</body>
</html>